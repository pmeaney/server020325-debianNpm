#cloud-config
groups:
  - debian: [root, sys]

users:
  - default
  - name: ${LINUX_USERNAME_HUMAN}
    gecos: Human Developer User - ${LINUX_USERNAME_HUMAN}
    shell: /bin/bash
    primary_group: ${LINUX_USERNAME_HUMAN}
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin, docker
    lock_passwd: false
    ssh_authorized_keys: ${LINUX_SSH_KEY_WITHPASS_HUMAN}

  - name: ${LINUX_USERNAME_CICDBOT_GHA}
    gecos: GitHub Actions CI/CD Bot - ${LINUX_USERNAME_CICDBOT_GHA}
    shell: /bin/bash
    primary_group: ${LINUX_USERNAME_CICDBOT_GHA}
    # gives passwordless sudo access specifically to docker and docker-compose commands
    sudo: ALL=(ALL) NOPASSWD:/usr/bin/docker,/usr/bin/docker-compose
    groups: docker
    lock_passwd: true
    ssh_authorized_keys: ${LINUX_SSH_KEY_NOPASS_CICDBOT_GHA}

chpasswd:
  expire: false
  users:
    - name: ${LINUX_USERNAME_HUMAN}
      password: ${LINUX_USERPASSWORD_HUMAN}
      type: text

package_update: true
package_upgrade: true
packages:
  - zsh
  - git
  - make
  - rsync

runcmd:
  # Update package lists before installing anything
  - sudo apt-get update
  # Install Docker using the official script
  - curl -fsSL https://get.docker.com -o get-docker.sh
  - sh get-docker.sh
  - sudo usermod -aG docker ${LINUX_USERNAME_HUMAN}
  # Install rsync with error handling
  - sudo apt-get install -y rsync || echo "Failed to install rsync"
