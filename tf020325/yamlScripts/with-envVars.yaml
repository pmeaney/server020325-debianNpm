#cloud-config
groups:
  - debian: [root, sys]

users:
  - default
  - name: ${LINUX_USERNAME_DEVOPS_HUMAN}
    gecos: Developer Access Account - ${LINUX_USERNAME_DEVOPS_HUMAN}
    shell: /bin/bash
    primary_group: ${LINUX_USERNAME_DEVOPS_HUMAN}
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin, docker
    lock_passwd: true
    # removing pw for ssh login-- setting lock_passwd to true
    # lock_passwd: false
    ssh_authorized_keys:
      - ${LINUX_HUMAN_SSH_KEY_PUB_NOPASS}

  - name: ${LINUX_USERNAME_GHA_CICD_BOT}
    gecos: GitHub Actions CI/CD Bot - ${LINUX_USERNAME_GHA_CICD_BOT}
    shell: /bin/bash
    primary_group: ${LINUX_USERNAME_GHA_CICD_BOT}
    # gives passwordless sudo access specifically to docker and docker-compose commands
    sudo: ALL=(ALL) NOPASSWD:/usr/bin/docker,/usr/bin/docker-compose
    groups: docker
    lock_passwd: true
    ssh_authorized_keys:
      - ${LINUX_GHACICD_BOT_SSH_KEY_PUB_NOPASS}

# removing pw for ssh login--
# commenting out chpasswd section since the human ssh key won't be using password authentication
# This creates our initial user
# chpasswd:
#   expire: false
#   users:
#     - name: ${LINUX_USERNAME_DEVOPS_HUMAN}
#       password: ${LINUX_USERPASSWORD_DEVOPS_HUMAN}
#       type: text

package_update: true
package_upgrade: true
packages:
  - zsh
  - git
  - make
  - rsync

runcmd:
  # Update package lists before installing anything
  - sudo apt-get update
  # Install Docker using the official script
  - curl -fsSL https://get.docker.com -o get-docker.sh
  - sh get-docker.sh
  - sudo usermod -aG docker ${LINUX_USERNAME_DEVOPS_HUMAN}
  # Install rsync with error handling
  - sudo apt-get install -y rsync || echo "Failed to install rsync"
